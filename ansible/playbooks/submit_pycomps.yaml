- name: Submit PyCOMPs Job
  hosts: all
  strategy: free
  tasks:

    - name: Set num_nodes
      set_fact:
        num_nodes: "{{ num_nodes_input }}"
      when:
        - num_nodes_input is defined
        - num_nodes_input | length > 0

    - name: Set data_path
      set_fact:
        data_path: "{{ data_path_input }}"
      when:
        - data_path_input is defined
        - data_path_input | length > 0

    - name: generate ssh cmd tasks
      set_fact:
        ssh_cmd_to_run: "module load COMPSs/2.9; enqueue_compss --qos=debug -d --num_nodes={{ num_nodes }} {{ command }}"

    - name: generate ssh cmd args
      set_fact:
        ssh_cmd_to_run: "{{ ssh_cmd_to_run }} {{ item }}"
      loop: "{{ arguments }}"

    - name: generate ssh command
      import_tasks: generate_ssh_cmd_tasks.yml

    - name: submit job
      shell: "{{ ssh_cmd }} 2>&1 | grep 'Submitted batch job' | tr -d 'Submitted batch job'"
      args:
        executable: /bin/bash
      environment:
        DATA_PATH: "{{ data_path }}"
        PRIVATE_KEY: "{{ key }}"
      register: ssh_output

    - name: Set job id
      set_fact:
        TOSCA_JOB_ID: "{{ ssh_output.stdout_lines[0] }}"